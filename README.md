# Ansible Role: install-alloy

–†–æ–ª—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ [Grafana Alloy](https://grafana.com/docs/alloy/) –Ω–∞ —Ö–æ—Å—Ç–∞—Ö –ª—é–±–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å –ø–æ–º–æ—â—å—é Ansible.

## üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–æ–≤ Prometheus –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ, —ç—Ç–∞ —Ä–æ–ª—å –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å Grafana Alloy ‚Äî –º–æ—â–Ω—ã–π –∞–≥–µ–Ω—Ç, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å Prometheus –∏ Loki.

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ —Ö–æ—Å—Ç –≥–æ—Ç–æ–≤ –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É:
- –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –Ω—É–∂–Ω—ã–µ `.alloy.disabled` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏,
- –∏–∑–º–µ–Ω–∏—Ç—å IP/–ø–æ—Ä—Ç—ã –ø–æ–¥ —Å–≤–æ—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É,
- –∏ Alloy —Å—Ä–∞–∑—É –Ω–∞—á–Ω—ë—Ç —Å–æ–±–∏—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏–ª–∏ –ª–æ–≥–∏.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–æ–ª–∏
ansible-scripts/
‚îî‚îÄ‚îÄ roles/
    ‚îî‚îÄ‚îÄ install-alloy/
        ‚îú‚îÄ‚îÄ defaults/
        ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
        ‚îú‚îÄ‚îÄ files/
        ‚îÇ   ‚îú‚îÄ‚îÄ alloy-1.7.5-1.amd64.deb         # –õ–æ–∫–∞–ª—å–Ω—ã–π deb-—Ñ–∞–π–ª (–µ—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
        ‚îÇ   ‚îú‚îÄ‚îÄ blackbox.alloy.disabled         # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ blackbox exporter
        ‚îÇ   ‚îú‚îÄ‚îÄ cadvisor.alloy.disabled         # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ cadvisor
        ‚îÇ   ‚îú‚îÄ‚îÄ docker_logs.alloy.disabled      # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ docker –¥–ª—è Loki
        ‚îÇ   ‚îú‚îÄ‚îÄ node.alloy.disabled             # node exporter
        ‚îÇ   ‚îú‚îÄ‚îÄ self.alloy.disabled             # self-monitoring Alloy
        ‚îÇ   ‚îî‚îÄ‚îÄ service/
        ‚îÇ       ‚îî‚îÄ‚îÄ alloy.service               # systemd unit-—Ñ–∞–π–ª
        ‚îú‚îÄ‚îÄ handlers/
        ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
        ‚îú‚îÄ‚îÄ tasks/
        ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
        ‚îú‚îÄ‚îÄ templates/
        ‚îÇ   ‚îú‚îÄ‚îÄ alloy.j2                        # –æ—Å–Ω–æ–≤–Ω–æ–π —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        ‚îÇ   ‚îú‚îÄ‚îÄ config.alloy.j2                 # –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
        ‚îÇ   ‚îî‚îÄ‚îÄ override.conf.j2                # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π systemd override
        ‚îî‚îÄ‚îÄ vars/
            ‚îú‚îÄ‚îÄ Debian.yml
            ‚îî‚îÄ‚îÄ main.yml

## üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alloy

–ü—Ä–∏–º–µ—Ä—ã –≤–∫–ª—é—á–∞–µ–º—ã—Ö –º–æ–¥—É–ª–µ–π:

| –ù–∞–∑–≤–∞–Ω–∏–µ            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                       |
|---------------------|----------------------------------|
| `blackbox`          | –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ HTTP/HTTPS  |
| `cadvisor`          | –ú–µ—Ç—Ä–∏–∫–∏ –∏–∑ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤    |
| `docker_logs`       | –õ–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è Loki |
| `node`              | –°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏                |
| `self`              | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∞–º–æ–≥–æ Alloy          |

–ö–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ `.alloy.disabled` —Ñ–∞–π–ª ‚Äî –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª, —É–±—Ä–∞–≤ `.disabled`.

## ‚öôÔ∏è –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏

```yaml
- name: Install Alloy and configure monitoring agent
  hosts: all
  become: true
  roles:
    - install-alloy
```

#‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!
–í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–∞–π–ª
`files/alloy-1.7.5-1.amd64.deb` ‚Äî —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π `.deb-—Ñ–∞–π–ª`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.
–í—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º–Ω–µ –Ω–µ—É–¥–∞–ª–æ—Å—å –µ–≥–æ –¥–æ–±–∞–≤–∏—Ç—å, –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ —Ä–∞–∑–º–µ—Ä–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.